---
title: "Messy Biographies to Clean Data - Structuring Text with LLMs and Pydantic"
subtitle: "FOO CAFE 13 years strong"
date: today
author: 
  - "Jonathan Jayes"
title-slide-attributes:
  data-background-image: "assets/preview_wide.png"
  data-background-position: "bottom 10"
  data-background-size: "90%"
  data-background-opacity: "0.4"
format: 
  revealjs:
    theme: [default, assets/clean.scss]
    code-overflow: wrap
    width: 1600
    height: 900
    fig-align: center
    default-image-extension: svg
    slide-number: c
    code-block-bg: true
    code-block-border-left: "#31BAE9"
    include-in-header: 
        - text: <link rel = "shortcut icon" href = "assets/favicon.ico" />

image: "assets/preview_wide.png"
favicon: "assets/favicon.ico"
execute: 
  eval: true
  echo: false
bibliography: references.bib


---

## Agenda


1. Whirlwind tour through Swedish economic history

2. Messy Biographies to Clean Data

3. Classification of occupational titles

. . . 

### Goals

1. Teach you something you didn't know about Sweden's economic history

2. Show how we make use of modern data science tools in academia

3. Share some learnings from academia RE off the shelf software

## About me 

::: {.columns}
::: {.column}

- PhD student in Economic History at Lund

- Work on economic development in Sweden and tools to turn archival data into stories

- Work part time as a data scientist at [Codera Analytics](https://codera.co.za/)

- From South Africa originally

:::
::: {.column}

```{r}
knitr::include_graphics("assets/jj_run.jpeg")
```

:::
::: 


# Whirlwind tour through Swedish economic history{visibility="uncounted" #sec-whirlwind-tour background-color="#1b9e77"}

![](assets/aYWyRzV_700bwp.jpeg)


## When did Sweden become richðŸ‡¸ðŸ‡ªðŸ’¸?

:::{.center}

```{r}
knitr::include_graphics("figures/ed_step1_sweden.png")
```

:::
. . .

We need more context

## When did Sweden become richðŸ‡¸ðŸ‡ªðŸ’¸?

:::{.center}

```{r}
knitr::include_graphics("figures/ed_step2_sweden_vs_all.png")
```

:::
. . .

Versus the rest of the world

## When did Sweden become richðŸ‡¸ðŸ‡ªðŸ’¸?

:::{.center}

```{r}
knitr::include_graphics("figures/ed_step5_sweden_uk_sa_vs_all.png")
```

:::

. . .

Versus the first industrializing country ðŸ‡¬ðŸ‡§ and South Africa TODO flag

## Why did Sweden become richðŸ‡¸ðŸ‡ª?

. . .

```{mermaid}
%%{init: {
  "theme": "base",
  "themeVariables": {
    /* Dark2 palette */
    "ganttCritTaskColor": "#1b9e77",        /* Phase 1 */
    "ganttCritTaskTextColor": "#ffffff",
    "ganttCritTaskBorderColor": "#1b9e77",

    "ganttActiveTaskColor": "#d95f02",      /* Phase 2 */
    "ganttActiveTaskTextColor": "#ffffff",
    "ganttActiveTaskBorderColor": "#d95f02",

    "ganttDoneTaskColor": "#7570b3",        /* Phase 3 */
    "ganttDoneTaskTextColor": "#ffffff",
    "ganttDoneTaskBorderColor": "#7570b3",

    "lineColor": "#888",
    "primaryColor": "#f5f5f5",
    "primaryBorderColor": "#888",
    "fontSize": "14px"
  }
}}%%

gantt
  title Sweden's Economic Development c. 1850â€“1975
  dateFormat  YYYY
  axisFormat  %Y

  %% Milestones (neutral)
  section Milestones
  Second Industrial Revolution begins :milestone, M1, 1890, 0d
  Post-war reconstruction era starts  :milestone, M2, 1945, 0d
  Swedish Golden Age winds down       :milestone, M3, 1975, 0d

  %% Phase 1 -> tag: crit (teal)
  section Foundations and First Industrial Wave
  Agrarian reforms and institutions   :crit, A1, 1820, 1870
  Export-led growth timber iron oats  :crit, A2, 1850, 1890
  National railway build-out state-led:crit, A3, 1855, 1895

  %% Phase 2 -> tag: active (orange)
  section Second Industrial Revolution
  Rise of engineering multinationals ASEA SKF Ericsson :active, B1, 1890, 1925
  American technology transfer learning-returning engineers :active, B2, 1900, 1935
  Taylorist methods diffuse           :active, B3, 1910, 1935
  US FDI and mass-production plants   :active, B4, 1910, 1930

  %% Phase 3 -> tag: done (purple)
  section Golden Age and the Swedish Model
  Post-war boom                       :done, C1, 1945, 1965
  Swedish Model consolidates          :done, C2, 1950, 1975
  Fordism at scale                    :done, C3, 1950, 1970


```

. . .

Many reasons!!

## Why did Sweden become richðŸ‡¸ðŸ‡ª?

### My preferred explanation: Sweden's Electrification

::::{.columns}

:::{.column width=50%}

![Income shares from @bengtsson2021WhatHappenedIncomes and rural electrification rates from @vattenfall1948ProcentuelltAntalElektrifierade](figures/00-electrification_and_inequality_line_and_stacked_bar_secondary_axis.png){width=600}

:::

:::{.column width=50%}

![](figures/2IR_1.JPG){.fragment}

![](figures/2IR_2.JPG){.fragment}


:::

::::

:::{.notes}

So why do we care about Sweden as a case study when we think about technological transformations? 


there are at least two reasons; 1 - Sweden was a fast adopter of electricity. After Jonas WenstrÃ¶m discovered three phase current in the late 19th century, Sweden rapidly electrified - with the electrification of rural areas advancing rapdily between 1900 and 1921, when the Western line - an important part of the grid, was completed. 

Second, Sweden in the early 20th century was undergoing a levelling in terms of inequality; we can see that the share of income going to to the top decile of the income distribution declined - so it is an intersting time with a great levelling taking place. 

Further, electrification as a general purpose technology drastically changed that way that we worked and lived; agricultural tasks that used to be very labour intensive were mechanised and then electrified, freeing up labour to move in to factories - which also were completely transformed by the electric motor, improving the quality of the jobs in the factory compared to the risks of belt drives from a central drive shaft, and allowing modular factory production, running only some machines at a time. 

:::

## Why did Sweden become richðŸ‡¸ðŸ‡ª?

### Learning and returning

![](assets/learning_and_returning.png)

## Why did Sweden become richðŸ‡¸ðŸ‡ª?

To answer the question of why Sweden became rich, we need to use source material from the time. 

:::: {.columns}

::: {.column width=33%}

<!-- ```{r}
knitr::include_graphics(here::here("assets/reading_ransom.jpg"))
``` -->

![](assets/reading_ransom.jpg){fig-align="center" width=100%}


:::

::: {.column width=33%}

<!-- ```{r}
knitr::include_graphics(here::here("assets/Electrolux_1950_page_5.jpeg"))
``` -->

![](assets/Electrolux_1950_page_5.jpeg){fig-align="center" width=100%}

:::

::: {.column width=33%}

<!-- ```{r}
knitr::include_graphics(here::here("assets/vem_page copy.png"))
``` -->

![](assets/vem_page copy.png){fig-align="center" width=100%}
:::

:::: 

# Messy Biographies to Clean Data{visibility="uncounted" #sec-structuring-data background-color="#1b9e77"}



## Who is who?

:::: {.columns}

::: {.column width="70%"}

Vem Ã¤r Vem? is a **Swedish biographical encyclopedia** that was published in two editions of five volumes each in 1945â€“1950 and 1962â€“1968 by BokfÃ¶rlaget Vem Ã¤r Vem.

The intention was, according to the publishers, to draw attention **to people who were at the height of their activities**, even if they were younger, in influential or otherwise noted positions in different areas.

- Biographies and career trajectories of ~ 75,000 individuals!

- 8 of the 10 volumes are digitized by librarians in Uppsala â€“ thank you <3

:::

::: {.column width="5%"}

:::

::: {.column width="25%"}

![](assets/vem_cover.png){fig-align="center" width=100%}

:::

::::

## Vem Ã¤r Vem? Volumes

![](assets/who-is-who-volumes.png){fig-align="center" width=100%}

```{r}
#| eval: false
library(tidyverse)
theme_set(theme_light())
library(ggtext)
library(showtext)
font_add_google("IBM Plex Mono", "ibm")
showtext_auto(enable = TRUE)

# Create a tibble from the JSON data
books <- tibble(
  book_name = c("SkÃ¥ne", "Stockholm", "Svealand", "The GÃ¶taland region except SkÃ¥ne", "SkÃ¥ne", "Norrland", "Stockholm", "The GÃ¶taland region except SkÃ¥ne", "Who is who in indsutry and business?"),
  year = c(1948, 1962, 1964, 1965, 1966, 1968, 1945, 1948, 1945),
  pages = c(624, 1498, 945, 1203, 952, 1340, 1044, 1075, 625),
  volume = c(1, 2, 2, 2, 2, 2, 1, 1, 3)
) 

books <- books %>%
    mutate(name = str_c(book_name, " - ", year),
            name = fct_reorder(name, pages),
            records = pages * 8) %>%
            mutate(volume = case_when(
                volume == 1 ~ "1945â€“1950", 
                volume == 2 ~"1962â€“1968",
                TRUE ~ "Who is who in indsutry and business?")
            ) %>%
    select(name, records, volume) 

# books %>% summarise(records = sum(records))

# Create the ggplot visualization
ggplot(books, aes(x = records, y = name, fill = factor(volume))) +
  geom_col(alpha = .8) +
  labs(x = "Number of biographies", y = "Book volume",
  title = "Number of biographies in Vem Ã¤r Vem?",
  fill = "Edition") +
  scale_x_continuous(labels = scales::number_format()) +
  scale_fill_manual(values = c("#2B8CBE", "#be5d2b", "midnightblue"))  +
    theme(plot.title.position = "plot") +
    theme(legend.position = "bottom") +
    theme(text = element_text(family = "ibm", size = 24))

ggsave("assets/who-is-who-volumes.png", width = 6, height = 4, units = "in", dpi = 300)
```


## Vem Ã¤r Vem? Example page

![](assets/vem_page.png){fig-align="center" width=100%}

## Vem Ã¤r Vem? Example biography

![](assets/vem_page close-up.jpg){fig-align="center" width=100%}


## Vem Ã¤r Karl Lund?

[Lund, Karl Gustaf]{style="background-color: #b0c4de"}, [chief engineer]{style="background-color: #d2b48c"}, [living in Varberg]{style="background-color: #d28ccdff"}, [born on July 22, 1893]{style="background-color: #ff8c69"}, [in Hille, GÃ¤vle County]{style="background-color: #e8ee90ff"}, Sweden, son of [clerk Ferdinand L. and Maria Andersson]{style="background-color: #9370db"}. Married in 1936 to [Sigrid Johansson]{style="background-color: #ffadc1"}. Children: [Ingvar (born 1938)]{style="background-color: #ffdead"}, [Lennart (born 1942)]{style="background-color: #ffdead"}. â€” Graduated from [Bergsskolan]{style="background-color: #afeeee"} in Filipstad in 1917, specialized studies at the [Royal Institute of Technology (KTH)]{style="background-color: #afeeee"} from 1920 to 1922, studied at the [Institute of Metallurgy]{style="background-color: #afeeee"} and [Stockholm University]{style="background-color: #afeeee"} in 1921-1922. Chemist at [StrÃ¶msnÃ¤s JÃ¤rnverks A-B]{style="background-color: #98fb98"} in Degerfors from 1918 to 1920, metallurgist and chemist at [Westinghouse Electric & Manufacturing Co.]{style="background-color: #98fb98"} in East Pittsburgh, PA, USA, from 1923 to 1926 and 1928 to 1929, chief metallurgist at [Laclede Steel Co.]{style="background-color: #98fb98"} in Alton, Illinois, USA, in 1927, furnace and steelworks engineer at [A-B Iggesunds Bruk]{style="background-color: #98fb98"} from 1929 to 1931, site manager at [Gunnebo Bruks Nya A-B, Varbergsverket]{style="background-color: #98fb98"}, since 1931. Member of the municipal executive committee, deputy chairman of the economic department, deputy member of the board of the power plant, chairman of [Varbergs Sparbank]{style="background-color: #ffdab9"}, employer representative in the district council of the county labor board, member of the board of [Varbergs LuftskyddsfÃ¶rening (Varberg Air Protection Association)]{style="background-color: #ffdab9"}, secretary of [Varbergs HÃ¶gerfÃ¶rening (Varberg Conservative Association)]{style="background-color: #ffdab9"}, chairman of the railway sick fund, and [Plant Society for Small Bird Friends]{style="background-color: #ffdab9"}. 

## Vem Ã¤r Karl Lund?

Traveled to [Germany]{style="background-color: #e6e6fa"} in 1921, 1923, 1930, and 1936, [Denmark]{style="background-color: #e6e6fa"}, [Czechoslovakia]{style="background-color: #e6e6fa"} in 1921, 1922, and 1923, [Austria]{style="background-color: #e6e6fa"} in 1921, and the [USA]{style="background-color: #e6e6fa"} from 1923 to 1929. Writings: ["Some fundamental factors for obtaining sharp thermal curves" (Transactions of the American Society for Steel Treating, co-authored with C. Benedicks and W. H. Dearden, 1925)]{style="background-color: #74b7ffff"}, ["Contemporary production of saw blades, circular saws, and machine knives" (Timber Industry, 1931)]{style="background-color: #74b7ffff"}. Hobbies: [hunting]{style="background-color: #ffd700"} and [fishing]{style="background-color: #ffd700"}.

##

![](assets/tidy.jpg)

# How can we `structure` the data?{#sec-structure background-color="#1C9E77" visibility="uncounted"}

## Why does a rules based approach not work?

### NLP challenges

:::: {.columns}

::: {.column width="50%"}

<br>

- Many abbreviations and contractions
    - DOB: "f\.\\s*(\\d{2})\\/(\\d{2})/(\\d{2})"
    - GÃ¤vleborg County: "GÃ¤vleb. l."

- Similar structure for each entry but not exactly the same information in the same order


:::

::: {.column width="50%"}

<br>

![](assets/Karl_Lund_crop.png){fig-align="center"}

:::

::::

## Goal

```{r}
knitr::include_graphics(here::here("assets/methods.png"))
```

## What do we need to do the data structuring?

1. Prompt

2. Schema for Output

3. Large Language Model to structure output

4. Quality Assurance

## What do we need to do the data structuring?

### Prompt

::: {.columns}
::: {.column}

#### Components:

1. Role

You are an expert on Swedish biographies.

2. Task


1. Use the schema to organize the information in the biography.
2. Keep the biographic descriptions in Swedish and remove any abbreviations based on your knowledge, e.g. 'fil. kand.' is 'filosofie kandidat', and 'Skarab. l.' is 'Skaraborgs LÃ¤n' etc. 
3. For missing data in a required field, include the field with a `None` value.
4. Ensure fields are correctly labeled and structured as per the schema.
5. Put years in full based on context. Put dates in DD-MM-YYYY format where possible. 


3. Details

:::
::: {.column}

TODO add image of the abbreviations

:::

:::





## Structure using OpenAI API ðŸ¤–{visibility="uncounted"}

### Using OpenAI's GPT-3.5 chat API:

We provide the system a schema to structure the record in, e.g. keys.

We provide the system the Swedish text

We specify the JSON response format we want



<br>

::: {.columns}
::: {.column}


```{python, eval=FALSE, echo=TRUE}
schema = {
    "type": "object",
    "required": [
        "full_name",
        "location",
        "occupation",
        "birth_details",
        "education",
        "career",
        "family",
    ],
    "properties": {
        "full_name": {"type": "string"},
        "location": {"type": "string"},
        "occupation": {"type": "string"},
        "birth_details": {
            "type": "object",
            "properties": {
                "date": {"type": "string"},
                "place": {"type": "string"},
                "parents": {"type": "string"},
            },
            "required": ["date", "place"],
        },}}"
```





:::
::: {.column}

```{python, eval=FALSE, echo=TRUE}

def structure_biography_info(page_text):
    try:
        # Create a prompt for the system
        structure_prompt = f"Task: read the schema and return RFC compliant JSON information about the Swedish individuals from the 1950 biographical dictionary 'Vem Ã¤r Vem' that is provided below. Use a numeric index for each biography in your JSON output and return information about all of them, including all career information available. Keep the biographic descriptions in Swedish and remove any abbreviations based on your knowledge, e.g. 'fil. kand.' is 'filosofie kandidat', and 'Skarab. l.' is 'Skaraborgs LÃ¤n'. Put years in full based on context. Put dates in dd/mm/yyyy format where possible. If there is no information for a key, leave it out. If there is no information for a required key, put NULL as the value.\nHere is the schema: {schema}.\nHere is the text: {page_text}. Go!"
        structure_response = client.chat.completions.create(
            model="gpt-3.5-turbo-1106",
            response_format={"type": "json_object"},
            messages=[
                {
                    "role": "system",
                    "content": "You are an expert on Swedish biographies.",
                },
                {"role": "user", "content": f"{structure_prompt}"},
            ],
        )

        structured_biography_info = json.loads(
            structure_response.choices[0].message.content
        )

        return structured_biography_info

    except Exception as e:
        print(f"Error in structure_biography_info: {e}")
        return None
```


:::
::: 


# Classification of occupational titles{visibility="uncounted" #sec-classification background-color="#1b9e77"}

Who is an engineer?

## HISCO codes

- Derived from ISCO (International Standard Classification of Occupations) 
- Invented for the sake of international comparability  
- Introduced by Leuwen, Maas, Miles (2002) based on ISCO68  
- Hiearchical structure well suited for analysis

```{r echo=FALSE, message=FALSE, warning=FALSE, out.height="300px", out.width="709px"}
# knitr::include_graphics("Figures/HISCO structure.png")
```

## References{visibility="uncounted"}

::: {#refs}

:::

